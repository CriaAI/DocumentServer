name: Deploy to ECS

on:
  push:
    branches: [main, master]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: criaai/documentserver
  ECS_CLUSTER: criaai
  ECS_SERVICE: documentserver
  TASK_DEFINITION: ecs/task-definition.json

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push to ECR
        id: build
        env:
          REGISTRY: ${{ steps.ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="$REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          IMAGE_LATEST="$REGISTRY/$ECR_REPOSITORY:latest"

          docker buildx build \
            --file Dockerfile.production \
            --tag "$IMAGE" \
            --tag "$IMAGE_LATEST" \
            --push \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            .

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Render task definition
        id: render
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
        run: |
          sed -e "s|\${ECR_IMAGE}|$IMAGE|g" \
              -e "s|\${EXECUTION_ROLE_ARN}|${{ vars.ECS_EXECUTION_ROLE_ARN }}|g" \
              -e "s|\${TASK_ROLE_ARN}|${{ vars.ECS_TASK_ROLE_ARN }}|g" \
              -e "s|\${JWT_SECRET_ARN}|${{ secrets.JWT_SECRET_ARN }}|g" \
              -e "s|\${EFS_ID}|${{ vars.EFS_ID }}|g" \
              -e "s|\${AWS_REGION}|${{ env.AWS_REGION }}|g" \
              ${{ env.TASK_DEFINITION }} > task-def-rendered.json

          echo "task_def=task-def-rendered.json" >> "$GITHUB_OUTPUT"

      - name: Register task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.render.outputs.task_def }}
          container-name: documentserver
          image: ${{ needs.build-and-push.outputs.image }}

      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 15
